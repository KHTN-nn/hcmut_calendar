<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCMUT TKB to Google Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 800px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        textarea { height: 200px; font-family: monospace; font-size: 12px; }
        .btn-primary { background-color: #003366; border: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center mb-4">üéì Chuy·ªÉn TKB MyBK sang Google Calendar</h2>
    <p class="text-muted text-center">H∆∞·ªõng d·∫´n: V√†o MyBK > TKB > Ctrl+A > Ctrl+C r·ªìi d√°n v√†o ƒë√¢y.</p>
    
    <div class="mb-3">
        <label class="form-label">Ng√†y Th·ª© 2 c·ªßa Tu·∫ßn 01 h·ªçc k·ª≥:</label>
        <input type="date" id="startDate" class="form-control" value="2025-12-29">
    </div>

    <div class="mb-3">
        <textarea id="rawInput" class="form-control" placeholder="D√°n n·ªôi dung copy t·ª´ MyBK v√†o ƒë√¢y..."></textarea>
    </div>

    <button onclick="processData()" class="btn btn-primary w-100 mb-3">T·∫°o file l·ªãch (.ics)</button>
    
    <div id="result" class="text-center" style="display:none;">
        <div class="alert alert-success">X·ª≠ l√Ω th√†nh c√¥ng!</div>
        <a id="downloadBtn" class="btn btn-success">üì• T·∫£i file .ics v·ªÅ m√°y</a>
        <p class="mt-3 small text-muted">Sau khi t·∫£i v·ªÅ, m·ªü Google Calendar > C√†i ƒë·∫∑t > Nh·∫≠p & Xu·∫•t ƒë·ªÉ t·∫£i file l√™n.</p>
    </div>
</div>

<script>
function processData() {
    const rawText = document.getElementById('rawInput').value;
    const startDate = new Date(document.getElementById('startDate').value);
    const lines = rawText.split('\n');
    let events = [];

    // Regex chu·∫©n ƒë·ªÉ b√≥c t√°ch d√≤ng TKB c·ªßa MyBK
    // Nh·∫≠n di·ªán c√°c c·ªôt: M√£ m√¥n, T√™n m√¥n, Th·ª©, Ti·∫øt, Gi·ªù, Ph√≤ng, C∆° s·ªü, Tu·∫ßn
    const regex = /(202\d{2})\s+([A-Z0-9]{6})\s+(.*?)\s+(\d+)\s+(\d+)\s+([A-Z0-9]+)\s+([2-7]|CN)\s+(\d+\s*-\s*\d+)\s+(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})\s+(.*?)\s+(BK-LTK|BK-DA)\s+(.*)/g;

    let match;
    while ((match = regex.exec(rawText)) !== null) {
        const item = {
            tenMon: match[3].trim(),
            thu: match[7],
            tiet: match[8],
            gio: match[9],
            phong: match[10].trim(),
            tuan: match[12].trim()
        };

        const weeks = item.tuan.split('|');
        const [tietBD, tietKT] = item.tiet.split('-').map(n => parseInt(n.trim()));
        const [gioBD, gioKT] = item.gio.split('-').map(t => t.trim());

        weeks.forEach((w, index) => {
            if (w !== '--') {
                const weekNum = parseInt(w);
                const dayOffset = (weekNum - 1) * 7 + (item.thu === 'CN' ? 6 : parseInt(item.thu) - 2);
                const eventDate = new Date(startDate);
                eventDate.setDate(startDate.getDate() + dayOffset);

                events.push({
                    summary: item.tenMon,
                    location: item.phong,
                    start: formatDate(eventDate, gioBD),
                    end: formatDate(eventDate, gioKT)
                });
            }
        });
    }

    if (events.length > 0) {
        generateICS(events);
    } else {
        alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu TKB h·ª£p l·ªá. H√£y copy l·∫°i to√†n b·ªô trang MyBK.");
    }
}

function formatDate(date, timeStr) {
    const [h, m] = timeStr.split(':');
    const d = new Date(date);
    d.setHours(parseInt(h), parseInt(m), 0);
    // Tr·∫£ v·ªÅ ƒë·ªãnh d·∫°ng YYYYMMDDTHHMMSSZ (UTC)
    return d.toISOString().replace(/[-:]/g, '').split('.')[0] + "Z";
}

function generateICS(events) {
    let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//HCMUT//NHAN_KI·ªÄU//VI\nCALSCALE:GREGORIAN\n";
    events.forEach(e => {
        ics += "BEGIN:VEVENT\n";
        ics += `SUMMARY:${e.summary}\n`;
        ics += `LOCATION:${e.location}\n`;
        ics += `DTSTART:${e.start}\n`;
        ics += `DTEND:${e.end}\n`;
        ics += "END:VEVENT\n";
    });
    ics += "END:VCALENDAR";

    const blob = new Blob([ics], { type: 'text/calendar' });
    const url = URL.createObjectURL(blob);
    const btn = document.getElementById('downloadBtn');
    btn.href = url;
    btn.download = 'TKB_BachKhoa.ics';
    document.getElementById('result').style.display = 'block';
}
</script>
</body>
</html>